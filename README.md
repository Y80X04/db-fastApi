# Автоматическое создание базы данных для FastAPI приложения

## Описание

Этот проект автоматически создает базу данных PostgreSQL при первоначальном запуске, создает необходимые таблицы и заполняет их начальными данными.

## Функциональность

- Автоматическое создание базы данных PostgreSQL
- Создание таблиц User, Role и Operation
- Заполнение таблиц начальными данными
- Выполнение миграций Alembic для создания таблиц
- Интеграция с FastAPI приложением

## Создаваемые таблицы

### Таблица Role
- `id` (Integer, Primary Key) - уникальный идентификатор роли
- `name` (String) - название роли
- `permissions` (JSON) - права доступа для роли

### Базовые роли:
- **admin**: полные права доступа (чтение, запись, удаление, администрирование)
- **user**: ограниченные права доступа (чтение, запись)

### Таблица User
- `id` (Integer, Primary Key) - уникальный идентификатор пользователя
- `email` (String) - email пользователя
- `username` (String) - имя пользователя
- `registered_at` (TIMESTAMP) - дата регистрации
- `role_id` (Integer, Foreign Key) - ссылка на роль пользователя
- `hashed_password` (String) - хэшированный пароль
- `is_active` (Boolean) - активен ли пользователь
- `is_superuser` (Boolean) - является ли суперпользователем
- `is_verified` (Boolean) - подтвержден ли email

### Базовые пользователи:
- **admin** (email: admin@example.com, пароль: admin123) - пользователь с полными правами
- **user** (email: user@example.com, пароль: user123) - пользователь с ограниченными правами

### Таблица Operation
- `id` (Integer, Primary Key) - уникальный идентификатор операции
- `quantity` (String) - количество
- `figi` (String) - финансовый инструмент
- `instrument_type` (String) - тип инструмента
- `date` (TIMESTAMP) - дата операции
- `type` (String) - тип операции

## Использование

### Автоматическая инициализация при запуске

При запуске FastAPI приложения база данных будет создана автоматически, если она не существует, и заполнена начальными данными.

### Ручная инициализация

Для полной инициализации выполните:

```bash
python init_complete.py
```

Или пошаговая инициализация:
```bash
# 1. Создание базы данных и таблиц
alembic upgrade head

# 2. Заполнение начальными данными
python seed_data.py
```

### Запуск приложения

```bash
uvicorn src.main:app --reload
```

или

```bash
python -m uvicorn src.main:app --reload
```

## Структура проекта

- `src/database_init.py` - основной модуль инициализации базы данных
- `src/main.py` - главный файл FastAPI приложения с автоматической инициализацией
- `seed_data.py` - скрипт заполнения начальными данными
- `init_complete.py` - полный скрипт инициализации
- `src/database.py` - настройки подключения к базе данных
- `src/config.py` - конфигурационный файл
- `alembic.ini` - конфигурация Alembic
- `migrations/` - директория с миграциями
- `migrations/versions/` - файлы миграций

## Как это работает

1. При запуске приложения или скрипта инициализации:
   - Проверяется наличие базы данных PostgreSQL
   - Если база данных отсутствует - она создается автоматически
   - Выполняются миграции Alembic для создания всех таблиц
   - Заполняются начальные данные (роли и пользователи)

2. Конфигурация базы данных и пароли загружаются из файла `.env`

## Требования

- Python 3.8+
- PostgreSQL сервер
- Установленные зависимости:
  - fastapi
  - sqlalchemy
  - asyncpg
  - alembic
  - python-dotenv
  - fastapi-users[sqlalchemy]
  - uvicorn

## Установка зависимостей

```bash
pip install fastapi sqlalchemy asyncpg alembic python-dotenv uvicorn fastapi-users[sqlalchemy]
```

## Конфигурация

Файл `.env` должен содержать следующие параметры:

```env
DB_HOST=localhost
DB_PORT=5439
DB_NAME=postgres
DB_USER=postgres
DB_PASS=postgres
SECRET_AUTH=your_secret_key_here

# Пароли по умолчанию для базовых пользователей
DEFAULT_ADMIN_PASSWORD=admin123
DEFAULT_USER_PASSWORD=user123
```

## Тестирование

Проверка работы приложения и базы данных:

```bash
python test_app.py
```

## Логирование

Все операции логируются с указанием времени выполнения и статуса операций.

## Особенности реализации

1. **Защита от дублирования**: система проверяет существование данных перед созданием
2. **Современный подход**: использование lifespan handlers вместо устаревшего on_event
3. **Надежная обработка ошибок**: подробное логирование всех операций
4. **Независимость компонентов**: каждый скрипт может работать отдельно
5. **Совместимость**: работает с существующей структурой FastAPI приложения
